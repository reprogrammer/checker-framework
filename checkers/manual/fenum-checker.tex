\htmlhr
\chapter{Fake Enum checker\label{fenum-checker}}

Java's 
\ahref{http://java.sun.com/docs/books/jls/third\_edition/html/classes.html\#8.9}{\code{enum}}
keyword lets you define an enumeration type: a finite set of distinct values
that are related to one another but are disjoint from all other
types, including other enumerations.
Before enums were added to Java there were two possible ways to handle
enumerations:

\begin{itemize}
\item using, as in C code, a set of \code{int} or \code{String} constants (known
as the fake enum pattern) is error-prone;

\item using a class with private constructor (known as the
\ahref{http://java.sun.com/developer/Books/shiftintojava/page1.html}{typesafe
enum pattern}) is a manual encoding of enumerations that needs
\ahref{http://www.javaworld.com/javaworld/javatips/jw-javatip122.html}{careful  development}.
\end{itemize}


However, sometimes you cannot use enums or the typesafe enum pattern.
A public API that predates Java's enum keyword may use \code{int} constants;
it cannot be changed, because doing so would break existing clients.
For example, Java's JDK still uses \code{int} constants in the AWT and Swing
frameworks.
In environments with limited resources, for example in the
\ahref{http://developer.android.com/guide/practices/design/performance.html\#avoid\_enums}{Android mobile phone
platform}, use of fake, rather than real enums or the typesafe enum pattern, can
improve performance.

In cases when code has to use the fake enum pattern, the fake enum (Fenum)
checker gives the same safety guarantees as a true enumeration type. 
The developer can introduce new types that are distinct from all values of the
base type and from all other fake enums. Fenums can be introduced for
primitive types as well as for reference types.


\section{Fake enum annotations}

The checker supports two ways to introduce a new fake enum (fenum):

\begin{enumerate}
\item Introduce your own specialized fenum annotation with code like this in
file \code{MyFenum.java}:

\begin{Verbatim}[commandchars=\\\[\]]
package \textit[myproject].quals;

import java.lang.annotation.*;
import checkers.quals.SubtypeOf;
import checkers.quals.TypeQualifier;

@Documented
@Retention(RetentionPolicy.RUNTIME)
@TypeQualifier
@SubtypeOf( { FenumTop.class } )
public @interface \textit[MyFenum] {}
\end{Verbatim}

You only need to adapt the package, annotation, and file names in the exampel.


\item Use the provided \code{@\refclass{fenum/quals}{Fenum}} annotation, that takes a
\code{String} argument to distinguish different fenums.
For example, \code{@Fenum("A")} and \code{@Fenum("B")} are two distinct fenums.
\end{enumerate}


The first approach allows you to define a short, meaningful name suitable for
your project, whereas the second approach allows quick prototyping.



\section{What the Fenum checker checks}

The Fenum checker ensures that unrelated types are not mixed. 
All types with a particular fenum annotation or \code{String} argument are
disjoint from all unannotated types and all types with a different fenum
annotation or \code{String} argument.

The checker forbids method calls on fenum types and ensures that
only compatible fenum types are used in comparisons and arithmetic operations
(if applicable to the annotated type).

It is the programmers responsibility that ensure that fields with a fenum type
are properly initialized before use. Otherwise, one might observe a \code{null}
reference or zero value in the field of a fenum type.



\section{Running the Fenum checker}

The Fenum checker can be invoked by running the following commands.

\begin{itemize}
  \item 
If you define your own annotation, provide the name of the annotation using the
\code{-Aquals} option:

\begin{Verbatim}[commandchars=\\\[\]]
  javac -processor checkers.fenum.FenumChecker
        \textit[-Aquals=myproject.quals.MyFenum] MyFile.java ...
\end{Verbatim}


\item
If your code uses the \code{@\refclass{fenum/quals}{Fenum}} annotation, you do
not need the \code{-Aquals} option:

\begin{Verbatim}
  javac -processor checkers.fenum.FenumChecker MyFile.java ...
\end{Verbatim}

\end{itemize}



\section{Suppressing Warnings}

One example of when you need to suppress warnings is when you initialize the
fenum constants to literal values.
To remove this warning message, add the corresponding \code{@SuppressWarnings} to either
the field or class declaration, for example:

\begin{Verbatim}
@SuppressWarnings("fenum:assignment.type.incompatible")
class MyConsts {
  public static final @Fenum("A") int ACONST1 = 1;
  public static final @Fenum("A") int ACONST2 = 2;  
}
\end{Verbatim}



\section{Example}

The following example introduces two fenums in class \code{TestStatic}
and then performs a few typical operations.

\begin{Verbatim}
@SuppressWarnings("fenum:assignment.type.incompatible")   // for initialization
public class TestStatic {
  public static final @Fenum("A") int ACONST1 = 1;
  public static final @Fenum("A") int ACONST2 = 2;

  public static final @Fenum("B") int BCONST1 = 4;
  public static final @Fenum("B") int BCONST2 = 5;
}

class FenumUser {
  @Fenum("A") int state1 = TestStatic.ACONST1;     // ok
  @Fenum("B") int state2 = TestStatic.ACONST1;     // Incompatible fenums forbidden!

  void fenumArg(@Fenum("A") int p) {}
	
  void foo() {
    state1 = 4;                     // Direct use of value forbidden!
    state1 = TestStatic.BCONST1;    // Incompatible fenums forbidden!
    state1 = TestStatic.ACONST2;    // ok

    fenumArg(5);                    // Direct use of value forbidden!
    fenumArg(TestStatic.BCONST1);   // Incompatible fenums forbidden!
    fenumArg(TestStatic.ACONST1);   // ok
  }
 }
\end{Verbatim}


\section{References}

\begin{itemize}
\item Java Language Specification on enums:\\
  \ahrefurl{http://java.sun.com/docs/books/jls/third\_edition/html/classes.html\#8.9}

\item Tutorial trail on enums:\\
  \ahrefurl{http://java.sun.com/docs/books/tutorial/java/javaOO/enum.html}

\item Typesafe enum pattern:\\
  \ahrefurl{http://java.sun.com/developer/Books/shiftintojava/page1.html}

\item Avoiding enums for performance:\\
  \ahrefurl{http://developer.android.com/guide/practices/design/performance.html\#avoid\_enums}

\item Java Tip 122: Beware of Java typesafe enumerations:\\
  \ahrefurl{http://www.javaworld.com/javaworld/javatips/jw-javatip122.html}

\end{itemize}