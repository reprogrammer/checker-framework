\htmlhr
\chapter{Fake Enum checker\label{fenum-checker}}

Java's 
\ahref{http://java.sun.com/docs/books/jls/third\_edition/html/classes.html\#8.9}{\code{enum}}
keyword lets you define an enumeration type: a finite set of distinct values
that are related to one another but are disjoint from all other
types, including other enumerations.
Before enums were added to Java, there were two ways to encode an
enumeration, both of which are error-prone:

\begin{description}
\item[the fake enum pattern]  a set of \code{int} or \code{String}
  constants (as often found in older C code).

\item[the \ahref{http://java.sun.com/developer/Books/shiftintojava/page1.html}{typesafe
enum pattern}]  a class with private constructor.
% This requires
% \ahref{http://www.javaworld.com/javaworld/javatips/jw-javatip122.html}{careful development}.
\end{description}

Sometimes you need to use the fake enum pattern,
rather than a real enum or the typesafe enum pattern.
%
One reason is backward-compatibility.  A public API that predates Java's
enum keyword may use \code{int} constants; it cannot be changed, because
doing so would break existing clients.  For example, Java's JDK still uses
\code{int} constants in the AWT and Swing frameworks.
%
Another reason is performance, especially in environments with limited
resources.  For example, the Android mobile phone platform
\ahref{http://developer.android.com/guide/practices/design/performance.html\#avoid\_enums}{recommends}
use of fake enums when only an integer value is needed, in order to reduce
code size and run time.

In cases when code has to use the fake enum pattern, the fake enum (Fenum)
checker gives the same safety guarantees as a true enumeration type. 
The developer can introduce new types that are distinct from all values of the
base type and from all other fake enums. Fenums can be introduced for
primitive types as well as for reference types.

Figure~\ref{fig:fenum-hierarchy} shows part of the type hierarchy for the
Fenum type system.

\begin{figure}
\includeimage{fenum}{2.5cm}
\caption{Partial type hierarchy for the Fenum type system.
Fenums that take the form of \code{@Fenum("A")} and \code{@Fenum("B")} are user
defined fenums while fenums that take the form of \code{@FenumC} and \code{@FenumD} are
built-in fenums. See section~\ref{fenum-annotations} for descriptions of how to
introduce both types of fenums. Fenums in gray should never be used but are
provided for the benefit of the type system.}
\label{fig:fenum-hierarchy}
\end{figure}

\section{Fake enum annotations\label{fenum-annotations}}

The checker supports two ways to introduce a new fake enum (fenum):

\begin{enumerate}
\item Introduce your own specialized fenum annotation with code like this in
file \code{\emph{MyFenum}.java}:

\begin{alltt}
package \textit{myproject}.quals;

import java.lang.annotation.*;
import checkers.quals.SubtypeOf;
import checkers.quals.TypeQualifier;

@Documented
@Retention(RetentionPolicy.RUNTIME)
@TypeQualifier
@SubtypeOf( \ttlcb{} FenumTop.class \ttrcb{} )
public @interface \textit{MyFenum} \ttlcb\ttrcb
\end{alltt}

You only need to adapt the package, annotation, and file names in the example.


\item Use the provided \code{@\refclass{fenum/quals}{Fenum}} annotation, which takes a
\code{String} argument to distinguish different fenums.
For example, \code{@Fenum("A")} and \code{@Fenum("B")} are two distinct fenums.
\end{enumerate}


The first approach allows you to define a short, meaningful name suitable for
your project, whereas the second approach allows quick prototyping.



\section{What the Fenum checker checks\label{fenum-checks}}

The Fenum checker ensures that unrelated types are not mixed. 
All types with a particular fenum annotation, or \code{@Fenum(...)} with a particular \code{String} argument, are
disjoint from all unannotated types and all types with a different fenum
annotation or \code{String} argument.

The checker forbids method calls on fenum types and ensures that
only compatible fenum types are used in comparisons and arithmetic operations
(if applicable to the annotated type).

It is the programmer's responsibility to ensure that fields with a fenum type
are properly initialized before use.  Otherwise, one might observe a \code{null}
reference or zero value in the field of a fenum type.  (The Nullness checker
(\chapterpageref{nullness-checker}) can prevent failure to initialize a
reference variable.)


\section{Running the Fenum checker\label{fenum-running}}

The Fenum checker can be invoked by running the following commands.

\begin{itemize}
  \item 
If you define your own annotation, provide the name of the annotation using the
\code{-Aquals} option:

\begin{alltt}
  javac -processor checkers.fenum.FenumChecker
        \textit{-Aquals=myproject.quals.MyFenum} MyFile.java ...
\end{alltt}


\item
If your code uses the \code{@\refclass{fenum/quals}{Fenum}} annotation, you do
not need the \code{-Aquals} option:

\begin{Verbatim}
  javac -processor checkers.fenum.FenumChecker MyFile.java ...
\end{Verbatim}

\end{itemize}



\section{Suppressing warnings\label{fenum-suppressing}}

One example of when you need to suppress warnings is when you initialize the
fenum constants to literal values.
To remove this warning message, add a \code{@SuppressWarnings} annotation to either
the field or class declaration, for example:

\begin{Verbatim}
@SuppressWarnings("fenum:assignment.type.incompatible")
class MyConsts {
  public static final @Fenum("A") int ACONST1 = 1;
  public static final @Fenum("A") int ACONST2 = 2;  
}
\end{Verbatim}



\section{Example\label{fenum-example}}

The following example introduces two fenums in class \code{TestStatic}
and then performs a few typical operations.

\begin{Verbatim}
@SuppressWarnings("fenum:assignment.type.incompatible")   // for initialization
public class TestStatic {
  public static final @Fenum("A") int ACONST1 = 1;
  public static final @Fenum("A") int ACONST2 = 2;

  public static final @Fenum("B") int BCONST1 = 4;
  public static final @Fenum("B") int BCONST2 = 5;
}

class FenumUser {
  @Fenum("A") int state1 = TestStatic.ACONST1;     // ok
  @Fenum("B") int state2 = TestStatic.ACONST1;     // Incompatible fenums forbidden!

  void fenumArg(@Fenum("A") int p) {}
	
  void foo() {
    state1 = 4;                     // Direct use of value forbidden!
    state1 = TestStatic.BCONST1;    // Incompatible fenums forbidden!
    state1 = TestStatic.ACONST2;    // ok

    fenumArg(5);                    // Direct use of value forbidden!
    fenumArg(TestStatic.BCONST1);   // Incompatible fenums forbidden!
    fenumArg(TestStatic.ACONST1);   // ok
  }
 }
\end{Verbatim}


\section{References\label{fenum-references}}

\begin{itemize}
\item Java Language Specification on enums:\\
  \ahrefurl{http://java.sun.com/docs/books/jls/third\_edition/html/classes.html\#8.9}

\item Tutorial trail on enums:\\
  \ahrefurl{http://docs.oracle.com/javase/tutorial/java/javaOO/enum.html}

\item Typesafe enum pattern:\\
  \ahrefurl{http://java.sun.com/developer/Books/shiftintojava/page1.html}

\item Avoiding enums for performance:\\
  \ahrefurl{http://developer.android.com/guide/practices/design/performance.html\#avoid\_enums}

\item Java Tip 122: Beware of Java typesafe enumerations:\\
  \ahrefurl{http://www.javaworld.com/javaworld/javatips/jw-javatip122.html}

\end{itemize}

% LocalWords:  enums typesafe Fenum Fenums fenum MyFenum quals fenums Aquals
% LocalWords:  TestStatic FenumC FenumD myproject RetentionPolicy TypeQualifier
% LocalWords:  SubtypeOf FenumTop MyFile
