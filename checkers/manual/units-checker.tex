\htmlhr
\chapter{Units checker\label{units-checker}}

For many applications, it is important to use the correct units of
measurement for primitive types.  For example, NASA's Mars Climate Orbiter
(cost: \$327 million) was lost because of a discrepancy between use
of the metric unit Newtons and the imperial measure Pound-force.

The \emph{Units Checker} ensures consistent usage of units.
For example, consider the following code:

\begin{alltt}
@m int meters = UnitsTools.toMeter(5);
@s int secs = UnitsTools.toSecond(2);
@mPERs int speed = meters / secs;
\end{alltt}

Due to the annotations \<@m> and \<@s>, the variables \code{meters} and \code{secs} are guaranteed to contain
only values with meters and seconds as units of measurement.
Utility class \code{\refclass{units}{UnitsTools}} provides methods to convert
unqualified integer literals to values of the corresponding unit.
The assignment of an unqualified value to \code{meters}, as in
\code{meters = 99}, will be flagged as an error by the Units Checker.

The division \code{meters/secs} takes the types of the two operands
into account and automatically determines that the result is of type
meters per second, signified by the \code{@mPERs} qualifier.



\section{Units annotations\label{units-annotations}}

The checker currently supports two varieties of units annotations:
kind annotations (\code{@Length}, \code{@Mass}, \dots) and
the SI units (\code{@m}, \code{@kg}, \dots).


Kind annotations can be used to declare what the expected unit of
measurement is, without fixing the particular unit used.
For example, one could write a method taking a \code{@Length} value,
without specifying whether it will take meters or kilometers.
We currently provide the following kind annotations:

\begin{description}
\item[\code{@\refclass{units/quals}{Area}}]

\item[\code{@\refclass{units/quals}{Current}}]

\item[\code{@\refclass{units/quals}{Length}}]

\item[\code{@\refclass{units/quals}{Luminance}}]

\item[\code{@\refclass{units/quals}{Mass}}]

\item[\code{@\refclass{units/quals}{Speed}}]

\item[\code{@\refclass{units/quals}{Substance}}]

\item[\code{@\refclass{units/quals}{Temperature}}]

\item[\code{@\refclass{units/quals}{Time}}]
\end{description}

\medskip


For each kind of unit, we provide the corresponding SI unit of
measurement.
We currently provide:

\begin{enumerate}
\item For \code{@Area}:
  the derived units
  square millimeters \code{@\refclass{units/quals}{mm2}},
  square meters \code{@\refclass{units/quals}{m2}}, and
  square kilometers \code{@\refclass{units/quals}{km2}}

\item For \code{@Current}:
  Ampere \code{@\refclass{units/quals}{A}}

\item For \code{@Length}:
  Meters \code{@\refclass{units/quals}{m}}
  and the derived units
  millimeters \code{@\refclass{units/quals}{mm}} and
  kilometers \code{@\refclass{units/quals}{km}}

\item For \code{@Luminance}:
  Candela \code{@\refclass{units/quals}{cd}}

\item For \code{@Mass}:
  kilograms \code{@\refclass{units/quals}{kg}}
  and the derived unit
  grams \code{@\refclass{units/quals}{g}}

\item For \code{@Speed}:
  meters per second \code{@\refclass{units/quals}{mPERs}} and
  kilometers per hour \code{@\refclass{units/quals}{kmPERh}}

\item For \code{@Substance}:
  Mole \code{@\refclass{units/quals}{mol}}

\item For \code{@Temperature}:
  Kelvin \code{@\refclass{units/quals}{K}}
  and the derived unit
  Celsius \code{@\refclass{units/quals}{C}}

\item For \code{@Time}:
  seconds \code{@\refclass{units/quals}{s}}
  and the derived units
  minutes \code{@\refclass{units/quals}{min}} and
  hours \code{@\refclass{units/quals}{h}}
\end{enumerate}


You may specify SI unit prefixes, using enumeration \code{\refclass{units/quals}{Prefix}}.
The basic SI units
(\code{@s}, \code{@m}, \code{@g}, \code{@A}, \code{@K},
 \code{@mol}, \code{@cd})
take an optional \code{Prefix} enum as argument.
For example, to use nanoseconds as unit, one could use
\code{@s(Prefix.nano)} as a unit type, and \<@mm> is equivalent to
\<@m(Prefix.milli)>.



\section{Extending the Units Checker\label{extending-units}}

You can create new kind annotations and unit annotations that are specific
to the particular needs of your project.  An easy way to do this is by
copying and adapting an existing annotation.  (In addition, search for all
uses of the annotation's name throughout the Units Checker implementation,
to find other code to adapt; read on for details.)

Here is an example of a new unit annotation.

\begin{alltt}
@Documented
@Retention(RetentionPolicy.RUNTIME)
@TypeQualifier
@SubtypeOf( \ttlcb{} Time.class \ttrcb{} )
@UnitsMultiple(quantity=s.class, prefix=Prefix.nano)
public @interface ns \ttlcb{}\ttrcb{}
\end{alltt}

The \code{@SubtypeOf} meta-annotation specifies that this annotation
introduces an additional unit of time.
The \code{@UnitsMultiple} meta-annotation specifies that this annotation
should be a nano multiple of the basic unit \code{@s}:  \code{@ns} and
\code{@s(Prefix.nano)}
behave equivalently and interchangeably.
Most annotation definitions do not have a \<@UnitsMultiple> meta-annotation.


To take full advantage of the additional unit qualifier, you need to
do two additional steps.
(1)~Provide methods that convert from unqualified types to types that use
the new unit.  
See class \code{UnitsTools} for examples (you will need to suppress a
checker warning in just those few locations).
(2)~Put the new unit in relation to existing units.
Provide an
implementation of the \code{UnitsRelations} interface as a
meta-annotation to one of the units.

See demonstration \code{demos/units-extension/} for an example
extension that defines Hertz (hz) as scalar per second, and defines an
implementation of \code{UnitsRelations} to enforce it.



\section{What the Units Checker checks\label{units-checks}}

The Units Checker ensures that unrelated types are not mixed. 

All types with a particular unit annotation are
disjoint from all unannotated types, from all types with a different unit
annotation, and from all types with the same unit annotation but a
different prefix.

Subtyping between the units and the unit kinds is taken into account,
as is the \code{@UnitsMultiple} meta-annotation.



\section{Running the Units Checker\label{units-running}}

The Units Checker can be invoked by running the following commands.

\begin{itemize}
\item
If your code uses only the SI units that are provided by the
framework, simply invoke the checker:

\begin{Verbatim}
  javac -processor checkers.units.UnitsChecker MyFile.java ...
\end{Verbatim}

\item 
If you define your own units, provide the name of the annotations using the
\code{-Aunits} option:

\begin{alltt}
  javac -processor checkers.units.UnitsChecker \
        \textit{-Aunits=myproject.quals.MyUnit,myproject.quals.MyOtherUnit} MyFile.java ...
\end{alltt}
\end{itemize}



\section{Suppressing warnings\label{units-suppressing}}

One example of when you need to suppress warnings is when you
initialize a variable with a unit type by a literal value.
To remove this warning message, it is best to introduce a static
method that converts from unqualified to qualified types and to
add a \code{@SuppressWarnings}
annotation to that method.
For examples, see class \code{UnitsTools}.


\section{References\label{units-references}}

\begin{itemize}
\item The GNU Units tool provides a comprehensive list of units:
  \ahrefurl{http://www.gnu.org/software/units/}
\end{itemize}

% LocalWords:  UnitsTools toMeter toSecond mPERs Candela cd kmPERh mol nano ns
% LocalWords:  milli RetentionPolicy TypeQualifier SubtypeOf UnitsMultiple hz
% LocalWords:  UnitsRelations Aunits MyFile
