<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<html>

<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" >
<title>Releasing the JSR 308 langtools and the Checker Framework</title>
<style type="text/css">
body { font-family: sans-serif; margin: 20px }
pre { background-color: #CCC; padding: 0.75em; }
</style>
</head>

<body>

<h1>This document is out of date!</h1>

It refers to old pathnames and repositories, and must be updated.

<h1>Releasing the JSR 308 langtools and checkers</h1>

<p>This document explains how to make a public release of the JSR 308
langtools and checkers.</p>

<p>The release process is mostly automated, but you should expect to
spend 30 to 60 minutes for each release you make. You will actually
make the release twice &mdash; first to a testing site, and then to the live
site.</p>

<p>Contents:</p>
<!-- start toc.  do not edit; run html-update-toc instead -->
<ul>
  <li>
    <ul>
      <li><a href="#Requirements">Requirements</a></li>
      <li><a href="#Setup">Initial setup</a></li>
      <li><a href="#Release">Making a release</a></li>
    </ul></li>
</ul>
<!-- end toc -->

<h2 id="Requirements">Requirements</h2>

<p>To make a release of the JSR 308 langtools and checkers, you need:</p>

<ul>
<li>JDK &ge; 6</li>
<li>Apache ant &ge; 1.6.5</li>
<li>access to AFS, and write permissions in <code>$pag/www/jsr308</code></li>
<li>a web-accessible directory like <code>public_html</code> (for
testing the release)</li>
</ul>

<p>You should have all of the above if you use a PAG machine.</p>


<h2 id="Setup">Initial setup</h2>

<ol>
<li>
<p>Add the <code>scripts</code> directory of the Daikon <code>invariants</code>
repository to your <code>PATH</code> (see instructions for <a
href="http://groups.csail.mit.edu/pag/daikon/mit/#getting-daikon">getting
Daikon</a> if you don't have access to a checkout).</p>
</li>

<li>If you have never made a release before or no longer have a
prepared release directory, set up a release directory as follows:
  
<ol>
<li>
  
<p>Create a new directory.  Place the directory in a non-AFS
  location such as a scratch partition, because a local disk is faster than
  AFS.</p>
  
<pre>
    mkdir -p /scratch/$USER/jsr308-release
    cd /scratch/$USER/jsr308-release
</pre>
</li>

<li>
<p>Check out the (entire) annotations repository:</p>
<pre>
    svn co file:///afs/csail/group/pag/projects/annotations
    cd annotations
    hg clone /afs/csail/group/pag/projects/annotations/langtools
    hg clone /afs/csail/group/pag/projects/annotations/langtools-unmodified
</pre>
</li>

<li><p>Copy some files from the JSR 308 site as the basis for a
testing site:</p>

<pre>
    cd release
    ant -f release.xml site-copy
</pre>

<p>and answer the prompt accordingly. The site will be created in
<code>~/public_html/jsr308test</code> by default.</p></li>

</ol>
</li>
</ol>

<h2 id="Release">Making a release</h2>

<ol>
<li><p>Ensure that your checkouts are up to date, you don't have any
    uncommitted changes, and all regression tests pass.</p>
</li>



<li><p>Edit the changelogs (<tt>$anno/langtools/changelog-jsr308.txt</tt> and
<tt>$anno/checkers/changelog-checkers.txt</tt>) to indicate what has changed
in this version.  (Hopefully, this has already been done by each person who
made a recent change.)
The changelogs should focus on user-visible changes, or very significant
implementation changes that may affect users.
</p>

<p>
Here are two ways to determine what has changed.
(Irritatingly, you may need to do "hg log" to figure out the right revision
number as of the date of the last release; yuck.  We should tag
releases instead.)
</p>

<p>Diff the manuals against the previous versions:</p>

<pre>
    cd $anno/checkers/manual
    svn diff -r "{2008-06-09}" > ~/tmp/checkers-manual-diff

    cd $anno/langtools
    hg diff -r50 > ~/tmp/langtools-diff
</pre>

<p>Use the version control logs since the last release: </p>

<pre>
    cd $anno
    svn log -v -r "{2008-06-09}:{2008-06-15}" > ~/tmp/annotations-log

    cd $anno/langtools
    hg log -r50:tip > ~/tmp/langtools-log
    hg log -r50:tip --style changelog > ~/tmp/langtools-log-with-filenames
</pre>

Again, make sure your checkouts are up-to-date and fully committed.
</li>


<li><p>Update your release checkout:</p>

<pre>
    cd /scratch/$USER/jsr308-release/annotations
    svn up
    cd langtools
    hg pull
    hg up
</pre>

<p>There shouldn't be any conflicts, since the release scripts shouldn't
make any serious local modifications (aside from version number
changes, which you'll check in later in the process).</p></li>

<li><p>Edit the release configuration in <code>release.properties</code> for
the test release:</p>

<ol>
<li>For a development release, set:
<pre>
    release.is.dev=true
    release.ver=dev-<em>yyyyMMDD</em>
</pre>
where <em>yyyyMMDD</em> is today's date, e.g., 20080307.
</li>

<li>For a stable release, set:
<pre>
    release.is.dev=false
    release.ver=<em>x.y.z</em>
</pre>
where the version number omits <em>z</em> if 0, e.g., 0.5 not 0.5.0.
</li>

<li><p>Ensure that the properties for the release location are set as
follows (e.g., <em>not</em> to the live JSR 308 site quite yet):</p>

<ul>  
<li><code>web.root.dir</code>: the location of your site copy, e.g.,
<code>~/public_html/jsr308test</code></li>
<li><code>sanitycheck.url</code>: the URL to access the <code>releases</code>
directory of your site copy, e.g.,
<code>http://www.cs.washington.edu/homes/${USER}/jsr308test/releases</code></li>
</ul>

<p>(You'll do a dry-run of the release to your site copy, and will only
update the live site after you've sanity-checked the release.)</p></li>

<li><p>You probably don't need to worry about
<code>repo.revision</code> and <code>repo.date</code> &mdash; whoever
patches langtools should update these properties when they commit the
patch.</p></li>

<li><p>Also, ensure <tt>doc/Makefile-jsr308-install</tt> variables are
up to date, especially <tt>JDK_7_BIN</tt> and build number in
<tt>test-langtools</tt> target.</p></li>

</ol>
</li>

<li><p>Do a dry-run of the release:</p>

<pre>
    cd /scratch/$USER/jsr308-release/annotations/release
    ant -f release.xml clean web sanitycheck
</pre>

<p>The <code>web</code> step will run <code>ant clean build-javac
build-javap</code> for langtools, and <code>ant clean dists
all-tests</code> for checkers, so if the build is broken or any
checker tests fail, you won't be able to continue. (If this is the
case, you should fix the issue, or contact someone who can via <a
href="mailto:checker-framework-dev@googlegroups.com">checker-framework-dev@googlegroups.com</a>.)</p>

<p>The <code>sanitycheck</code> step unzips the releases from the website, then
rebuilds both projects and runs tests on the source and binary versions
from the release.</p>

<p>If all steps pass and you see <code>BUILD SUCCESSFUL</code>, then
proceed.  Otherwise, fix the problems and repeat the ant command.</p></li>


<li><a name="sanity-check"></a><p>Sanity-check the release.
If there are any problems, correct them in the repository and re-make the
release.
</p>

<ol>

<li>
<p>Run one of these:</p>

<pre>
$INV/scripts/checklink -q -r -e `cat $INV/scripts/checklink-args.txt` http://www.cs.washington.edu/homes/${USER}/jsr308test/
</pre>

<p>
where $INV is a checkout of Daikon's "invariants" repository.
[This should be merged into the <tt>sanitycheck</tt> target.]
</p>

</li>

<li><p>As a new user with no customizations (say, in a
virtual machine, or as user <tt>paguser</tt> at CSAIL), follow the Checker
Framework short installation instructions by executing these commands:</p>

<pre>
export JSR308_WEB=http://www.cs.washington.edu/homes/${USER}/jsr308test/current
cd
wget -nv -N ${JSR308_WEB}/Makefile-jsr308-install
make -f Makefile-jsr308-install
</pre>

<p>
</p>

</li>
</ol>
</li>

<li><p>Edit the release configuration in <code>release.properties</code> for
the actual release:</p>

<pre>
    web.root.dir=/afs/csail/group/pag/www/jsr308
    sanitycheck.url=http://types.cs.washington.edu/jsr308/releases
</pre></li>


<li>Make the final release:

<pre>
    cd /scratch/$USER/jsr308-release/annotations/release
    ant -f release.xml clean web sanitycheck
</pre>

<p>The same process as in the dry-run occurs; chances are, if the
dry-run passed successfully, this step should pass as well.</p>

</li>

<li><a href="#sanity-check">Sanity-check</a> the release, following the
  instructions above but slightly changing
  the commands to be:
<ol>
<li>
<pre>
$INV/scripts/checklink -q -r -e `cat $INV/scripts/checklink-args.txt` http://types.cs.washington.edu/checker-framework/
</pre>
</li>

<li>
<pre>
cd
wget -nv -N http://types.cs.washington.edu/checker-framework/current/Makefile-jsr308-install
make -f Makefile-jsr308-install
</pre>
</li>
</ol>

</li>

<li><p>Check in any changes made to version numbers and dates as part of
the release process.  (Should this be done before the release, so
that its data is consistent?)</p>

<pre>
    cd /scratch/$USER/jsr308-release/annotations
    svn diff
    # Review the changes output by "svn diff" before committing
    svn commit
</pre>
</li>

<li>
Copy <tt>checkers.jar</tt> to some libraries that use it (set <i>XXX</i> properly!):
<pre>
  cp -pf .../checkers.jar ${inv}/java/lib
  cvs commit ${inv}/java/lib/chekcers.jar -m "checkers.jar version <i>XXX</i>"
  cp -pf .../checkers.jar ${inv}/java/utilMDE/lib
  cvs commit ${inv}/java/utilMDE/lib/chekcers.jar -m "checkers.jar version <i>XXX</i>"
</pre>

<li><p>Send a release announcement to <a
href="mailto:jsr308-discuss@groups.google.com">jsr308-discuss@groups.google.com</a>.
The announcement should indicate what is new in the release, and should
include the changelogs at the end.</p></li>

</ol>

</body>
</html>

<!--  LocalWords:  JSR langtools serif px pre CCC JDK AFS PAG mkdir cd svn co
 -->
<!--  LocalWords:  xml ver dev yyyyMMDD URL url diff hg INV buildfile
 -->
