<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<html>

<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" >
<title>Releasing the JSR 308 langtools and the Checker Framework</title>
<style type="text/css">
body { font-family: sans-serif; margin: 20px }
pre { background-color: #CCC; padding: 0.75em; }
</style>
</head>

<body>

<h1>Releasing the JSR 308 langtools and checkers</h1>

<p>This document explains how to make a public release of the JSR 308
langtools and checkers.</p>

<p>The release process is mostly automated, but you should expect to
spend 30 to 60 minutes for each release you make. You will actually
make the release twice &mdash; first to a testing site, and then to the live
site.</p>

<p>Contents:</p>
<!-- start toc.  do not edit; run html-update-toc instead -->
<ul>
  <li>
    <ul>
      <li><a href="#Requirements">Requirements</a></li>
      <li><a href="#Setup">Initial setup</a></li>
      <li><a href="#Release">Making a release</a></li>
    </ul></li>
</ul>
<!-- end toc -->

<h2 id="Requirements">Requirements</h2>

<p>To make a release of the JSR 308 langtools and checkers, you need:</p>

<ul>
<li>JDK &ge; 6</li>
<li>Apache ant &ge; 1.6.5</li>
<li>Access to <code>/cse/www2/types</code> html folder.</li>
<li>Mercurial &ge; 1.2.1</li>
<li>LaTeX (along with <code>hevea</code> and <code>bibtex</code>)</li>
<li>a web-accessible directory like <code>public_html</code> (for
testing the release)</li>
</ul>

<p>You should have all of the above if you use a Washington CS machine
(e.g. <code>godwit</code>).</p>


<h2 id="Setup">Initial setup</h2>

<ol>
<li>
<p>Add the <code>scripts</code> directory of the Daikon <code>invariants</code>
repository to your <code>PATH</code> (see instructions for <a
href="http://groups.csail.mit.edu/pag/daikon/mit/#getting-daikon">getting
Daikon</a> if you don't have access to a checkout).  Mike has a (usually)
fresh checkout at <code>~mernst/research/invariants/scripts</code></p>
</li>

<li>
<p>Ensure that the various tools needed for the release are in your
<code>PATH</code>.  The files are scattered around the following
folders: <code>~mernst/bin/share</code>, <code>~mernst/bin/Linux-i686</code>,
and <code>/uns/bin</code>.
</li>

<li>If you have never made a release before or no longer have a
prepared release directory, set up a release directory as follows:
  
<ol>
<li>
  
<p>Create a new directory.  Place the directory in a non-NFS
  location such as a scratch partition, because a local disk is faster than
  NFS.</p>
  
<pre>
    mkdir -p /scratch/$USER/jsr308-release
    cd /scratch/$USER/jsr308-release
</pre>
</li>

<li>
<p>Check out the (entire) annotations repository:</p>
<pre>
    hg clone https://checker-framework.googlecode.com/hg/ checker-framework
    hg clone https://jsr308-langtools.googlecode.com/hg/ jsr308-langtools
    # Just to be in safe side
    cd checker-framework; ln -s ../jsr308-langtools jsr308-langtools
</pre>
</li>

<li><p>Copy some files from the JSR 308 site as the basis for a
testing site:</p>

<pre>
    cd release
    ant -f release.xml site-copy
</pre>

<p>and answer the prompt accordingly. The site will be created in
<code>~/www/jsr308test</code> by default.</p></li>

</ol>
</li>
</ol>

<h2 id="Release">Making a release</h2>

<ol>
<li><p>Ensure that your checkouts are up to date, you don't have any
    uncommitted changes, and all regression tests pass.</p>
</li>



<li><p>Edit the changelogs (<tt>$anno/jsr308-langtools/doc/changelog-jsr308.txt</tt> and
<tt>$anno/checkers-framework/checkers/changelog-checkers.txt</tt>) to indicate
what has changed in this version.  (Hopefully, this has already been done by
each person who made a recent change.)
The changelogs should focus on user-visible changes, or very significant
implementation changes that may affect users.
</p>

<p>
Here are two ways to determine what has changed.
(Irritatingly, you may need to do "hg log" to figure out the right revision
number as of the date of the last release; yuck.  We should tag
releases instead.)
</p>

<p>Diff the manuals against the previous versions:</p>

<pre>
    cd $anno/checkers-framework/checkers/manual
    hg diff -r130 > ~/tmp/checkers-manual-diff

    cd $anno/jsr308-langtools
    hg diff -r50 > ~/tmp/langtools-diff
</pre>

<p>Use the version control logs since the last release: </p>

<pre>
    cd $anno/checker-framework
    hg log -v -r130:tip > ~/tmp/annotations-log

    cd $anno/jsr308-langtools
    hg log -r50:tip > ~/tmp/langtools-log
    hg log -r50:tip --style changelog > ~/tmp/langtools-log-with-filenames
</pre>

Again, make sure your checkouts are up-to-date and fully committed.
</li>


<li><p>Update your release checkout:</p>

<pre>
    cd /scratch/$USER/jsr308-release/checker-framework
    hg fetch    # eq to 'hg pull; hg up'
    cd jsr308-langtools
    hg fetch    # eq to 'hg pull; hg up'
</pre>

<p>There shouldn't be any conflicts, since the release scripts shouldn't
make any serious local modifications (aside from version number
changes, which you'll check in later in the process).</p></li>

<li><p>Ensure that the properties for the dry-run release is set
appropriately, set as follows:</p>

<ul>  
<li><code>web.dry.root.dir</code>: the location of your site copy, e.g.,
<code>~/www/jsr308test</code></li>
<li><code>sanitycheck.dry.url</code>: the URL to access the <code>releases</code>
directory of your site copy, e.g.,
<code>http://www.cs.washington.edu/homes/${USER}/jsr308test/releases</code></li>
</ul>

<p>(You'll do a dry-run of the release to your site copy, and will only
update the live site after you've sanity-checked the release.)</p></li>

<li><p>Do a dry-run of the release:</p>

<pre>
    cd /scratch/$USER/jsr308-release/checker-framework/release
    ant -f release.xml -Drelease.ver=&lt;release version> clean web sanitycheck
</pre>

<p>The <code>web</code> step will run <code>ant clean build-javac
build-javap</code> for langtools, and <code>ant clean dists
all-tests</code> for checkers, so if the build is broken or any
checker tests fail, you won't be able to continue. (If this is the
case, you should fix the issue, or contact someone who can via <a
href="mailto:checker-framework-dev@googlegroups.com">checker-framework-dev@googlegroups.com</a>.)</p>

<p>The <code>sanitycheck</code> step unzips the releases from the website, then
rebuilds both projects and runs tests on the source and binary versions
from the release.</p>

<p>If all steps pass and you see <code>BUILD SUCCESSFUL</code>, then
proceed.  Otherwise, fix the problems and repeat the ant command.</p></li>


<li><a name="sanity-check"></a><p>Sanity-check the release.
If there are any problems, correct them in the repository and re-make the
release.
</p>

<ul>

<li><p>As a new user with no customizations (say, in a
virtual machine), follow the Checker
Framework short installation instructions by executing these commands:</p>

<pre>
export JSR308_WEB=http://www.cs.washington.edu/homes/${USER}/jsr308test/jsr308
cd
wget -nv -N ${JSR308_WEB}/Makefile-jsr308-install
make -f Makefile-jsr308-install
</pre>

<p>
</p>

</li>
</ul>

<li>Make the final release:

<pre>
    cd /scratch/$USER/jsr308-release/checker-framework/release
    ant -f release.xml -Drelease.ver=&lt;release version> -Drelease.is.real=true clean web checklinks sanitycheck
</pre>

<p>The same process as in the dry-run occurs; chances are, if the
dry-run passed successfully, this step should pass as well.</p>

</li>

<li>Again test the simple installation instructions guideline:
<pre>
cd
wget -nv -N http://types.cs.washington.edu/jsr308/Makefile-jsr308-install
make -f Makefile-jsr308-install
</pre>
</li>

<li><p>Check in any changes made to version numbers and dates as part of
the release process.  (Should this be done before the release, so
that its data is consistent?)</p>

<pre>
    cd /scratch/$USER/jsr308-release/annotations
    hg diff
    # Review the changes output by "hg diff" before committing
    hg commit; hg push
</pre>
</li>

<li>
Copy <tt>checkers.jar</tt> to some libraries that use it (set <i>XXX</i> properly!):
<pre>
  cp -pf .../checkers.jar ${inv}/java/lib
  cvs commit ${inv}/java/lib/chekcers.jar -m "checkers.jar version <i>XXX</i>"
  cp -pf .../checkers.jar ${inv}/java/utilMDE/lib
  cvs commit ${inv}/java/utilMDE/lib/chekcers.jar -m "checkers.jar version <i>XXX</i>"
</pre>

<li><p>Send a release announcement to <a
href="mailto:jsr308-discuss@groups.google.com">jsr308-discuss@groups.google.com</a>.
The announcement should indicate what is new in the release, and should
include the changelogs at the end.</p></li>

</ol>

</body>
</html>

<!--  LocalWords:  JSR langtools serif px pre CCC JDK AFS PAG mkdir cd svn co
 -->
<!--  LocalWords:  xml ver dev yyyyMMDD URL url diff hg INV buildfile
 -->
